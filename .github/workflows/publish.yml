name: Publish Python Package

on:
    push:
        tags:
            - '*.*.*'
    workflow_dispatch:
        inputs:
            version:
                description: 'Version to publish (leave empty to use current version)'
                required: false
                type: string
    workflow_call:
        inputs:
            version:
                description: 'Version to publish (leave empty to use current version)'
                required: false
                type: string

permissions:
    contents: write
    packages: write

jobs:
    build-and-publish:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: '3.12'

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install build twine setuptools wheel

            - name: Extract version
              id: get_version
              run: |
                  cd src
                  if [ -n "${{ github.event.inputs.version }}" ]; then
                    VERSION="${{ github.event.inputs.version }}"
                  elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
                    VERSION="${GITHUB_REF#refs/tags/}"
                  else
                    VERSION=$(grep 'current_version = ' pyproject.toml | sed 's/.*current_version = "\(.*\)"/\1/')
                  fi
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "Publishing version: $VERSION"

            - name: Build package
              run: |
                  cd src
                  python -m build
                  ls -la dist/

            - name: Check package
              run: |
                  cd src
                  twine check dist/*

            - name: Publish to GitHub Packages
              env:
                  TWINE_USERNAME: __token__
                  TWINE_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
                  TWINE_REPOSITORY_URL: https://upload.pypi.org/legacy/
              run: |
                  cd src
                  # Configure pip to use GitHub Packages
                  python -m twine upload \
                    --repository-url https://upload.pypi.org/legacy/ \
                    --username __token__ \
                    --password ${{ secrets.GITHUB_TOKEN }} \
                    dist/* || echo "Upload failed, trying alternative method..."

                  # Alternative: Upload to GitHub Packages PyPI repository
                  python -m twine upload \
                    --repository-url https://maven.pkg.github.com/${{ github.repository }} \
                    --username ${{ github.actor }} \
                    --password ${{ secrets.GITHUB_TOKEN }} \
                    dist/* || true

            - name: Create GitHub Release
              if: startsWith(github.ref, 'refs/tags/')
              uses: softprops/action-gh-release@v1
              with:
                  files: src/dist/*
                  generate_release_notes: true
                  body: |
                      ## iden_q_auto_platform ${{ steps.get_version.outputs.version }}

                      ### Installation
                      ```bash
                      pip install iden_q_auto_platform==${{ steps.get_version.outputs.version }}
                      ```

                      ### What's Changed
                      See the [CHANGELOG](https://github.com/${{ github.repository }}/blob/main/src/CHANGELOG.md) for details.
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Upload artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: python-package-distributions
                  path: src/dist/
